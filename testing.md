# TESTING

At this stage, all the information generated by the **SCANNING** is received and actions are executed that allow at least one Penetration to be carried out. Penetration is understood as the action that allows:

- At the External Infrastructure level: executing commands at the unprivileged and/or privileged user level on a target exposed to the Internet.
- At the Internal Infrastructure level: executing commands at the unprivileged and/or privileged user level on a target exposed on the internal or private network.
- At the application level: managing to exploit a vulnerability that leads to unauthorized access to a specific functionality or data or that allows the application to be used as a means to carry out other types of attacks where the target is the application itself, another application, the infrastructure that supports the application or the users of the application.
  
This stage considers two modules that commonly lead to penetration: Testing with exploits and/or Testing with credentials. In both cases, this may refer to the use of some program (exploit) or exploitation technique (such as when a vulnerability in an API is exploited by altering requests and/or responses).

This stage allows for the execution of actions that have been evaluated and designed in the previous stage and, therefore, allows for obtaining results that help in the analysis of the criticality of the vulnerabilities. However, the additional Privilege Escalation steps allow for obtaining results that determine higher levels of criticism and the possibility of expanding the Penetration carried out with the objective of obtaining access to privileged data or privileged functionalities or confidential information or, even, to take full control of a complete component of the infrastructure services (such as obtaining DA in the AD) or arbitrary and total access to the data handled by an application (even to the data of related applications or those that share resources [as occurs in several SaaS]).

## TEST WITH EXPLOITS

The concept of exploit has changed a lot and it is becoming more and more difficult to use this term. Moving away from strict terminology, let's consider an exploit to be a program that allows unauthorized actions to be carried out through an infrastructure service or an application. This program may have been called PoC (Proof of Concept) or a sequence of steps that have been documented and that allow the same effect to be obtained as a program that automates the exploitation action.

The use of exploits at the level of infrastructure services (at the server and/or client level) is very common and there is no completely reliable source to obtain them. For example, widely recognized frameworks such as MetaSploit were indirect victims of attacks on the organization that developed them (reports from 2008 and 2013 indicate that no release was affected). Therefore, it is the obligation of pentesters to check in advance the validity of the exploit being used and this is where teamwork is important because not every pentester can have the knowledge and experience required for this, it is part of the specialization.

In the case of applications, it is most common that exploitation techniques are used and some programs that are used are not exploits but helper programs. For example, for the exploitation of deserialization vulnerabilities, a tool like Ysoserial only helps to "combine" a set of functionalities in commonly used libraries. These chained functionalities or gadgets have secondary effects that are used to exploit deserialization vulnerabilities that are created in applications that are poorly made in the security aspect. Therefore, Ysoserial could even be used in administrative tasks allowed as a "helper".

Another important aspect that must be understood is that during a pentest there is no time to develop new exploits. Although it is feasible that during a pentest, the pentester finds a vulnerability not previously reported by anyone, an automated exploitation can be obtained, but in the form of a PoC, i.e. an automation that is only useful for the context evaluated during the particular pentest (context that varies by software versions, patch levels, specific configuration, available time conditions, connectivity conditions, etc.)

## TEST WITH CREDENTIALS

The definition of credentials and their use is diverse as formats can vary and the way of using them as well. For example, the easiest to understand is when usernames and passwords are obtained in plain text or when they are inferred (the most common is to infer the password from an existing username). The obtained passwords can be secured by being encrypted or by having been subjected to hashing or both. Reversing the encryption or finding a hash collision can be complex or not for various reasons (complexity of the passwords, algorithms used, etc.). Therefore, in some cases the real impossibility during a pentest of cracking a password leads the pentester to try to reuse the password in the format that has been obtained (as in the pass-the-hash step in some authentication processes).

The obtaining of the credentials should have occurred, ideally, during the **RECON** stage, but also during the **TESTING** stage itself. From these obtained credentials, dictionaries suitable for the authentication process that the pentester is facing must be created.

Particular care must be taken with dictionary attack tests as they can generate conditions for blocking user accounts temporarily and/or permanently, thereby causing the service to create a serious problem for the affected users or even the entire organization. All of this must be carefully evaluated and coordinated before executing it.

Cases of multi-factor authentication and the evasion of controls such as captchas are part of the analysis that will quickly determine whether it is feasible to attempt these attacks or not.

For example, the dependence on a physical token or other device can be a highly restrictive measure in the middle of a pentest, but if you want to recreate the exact conditions of a specific attack, you can coordinate the necessary conditions: when evaluating an online banking application, you can establish in the scope that test bank accounts are opened and that the necessary means to use them are requested, including physical tokens or the applications that generate them.

Dictionary-based attacks are feasible, under the conditions described above, at the infrastructure, application and API levels.

In all these cases, they can result in successful conditions by breaching the authentication process, but, otherwise, they can also allow determining that adequate protections do not exist. For example, when a dictionary attack is carried out on an application's authentication process with a dictionary that does not contain valid credentials, but that does not generate any unavailability condition, it must be reported because it even implies failures in the protection of the APIs involved, even if there is no limit on the usage/consumption ratio. Of course, in this last condition (unsuccessful authentication bypass), it must be reported only at the informational level.

## PENETRATION

Penetration, once obtained, determines elements that must allow:
- Establishment: penetration must be firm in the sense that it must be able to be triggered an indeterminate number of times. Some conditions may prevent this, such as context or the fact that they may lead to DoS. Establishment may include the use of techniques that allow evasion of network protections (such as segmentation and/or XDR) or EDRs or IPSs or WAFs or simple anti-virus.
- Pivot: penetration must allow the exploited victim to be used appropriately as a springboard to other information assets and/or hosts (strictly speaking, it should only be to targets in scope, but there are conditions where not revealing the misuse of a host would represent an unreported risk).
- Exfiltration: penetration must analyze ways to extract data to a computer controlled by the pentester and make use of the available and permitted network protocols.
- Persistence: Operational state changes should not be an impediment to maintaining access gained through penetration. For example, rebooting the target should not result in losing access. These types of conditions are commonly obtained through privilege escalation.

All of this may or may not be feasible and will depend on security controls at the infrastructure and/or application level. As with the evasion of protections, the impossibility should be documented and reported at the executive level (the technical detail can be requested by the organization being assessed).

Situations should be considered in which a vulnerability at the application level can lead to network penetration and vice versa. Exploiting a vulnerability at the level of a CMS (an application after all) can allow penetration actions at the level of the internal network (such as when an RPC [xmlrpc] API is abused).

## PRIVILEGE ESCALATION

It is important to note that although escalation is a step that must be taken (or at least attempted), it will not always be required to demonstrate critical risks. For example, if a vulnerability in an application allows full control of the application (through a supposedly non-privileged user account), it does not matter if access is not obtained at the DBA or SYSTEM/root or developer level.

The forms of vertical escalation can be:
- Vertical escalation when access is gained to higher-level privileges.
- Horizontal escalation when access is gained to privileges of the same level, but from another identity. This can be useful to the extent that, despite having the same type of privileges, they can be over other information assets.

Escalation at the infrastructure level is based on local vulnerabilities that may involve the use of exploits or the abuse of wrong configurations or the abuse of processes or the abuse of already installed applications. The main obstacle in these actions is the evasion of local protections.

Application-level escalation is more geared toward impersonating identities that have more privileges. However, situations involving authentication processes or access controls or poor session management can lead to privilege escalation.

While some strategies can be established regarding how to escalate privileges, it is also true that they depend greatly on the knowledge obtained after penetration of the specific target.

### ELEMENTS USED DURING TESTING

**The following sections involve elements that are dependent on the findings. Therefore, only elements that have the ability to help in checking vulnerabilities in various types of targets (operating systems/base software/applications) are referenced. Similarly, in the case of applications, there will be various tools depending on the type of testing (DAST/SAST/IAST).**

#### Exploit Sources

- NMAP (some scripts allow exploiting vulnerabilities as they are)
- Metasploit
- Those found in exploit-db
- Those found in GitHub (check as much as possible)

#### Exploitation using Credentials

- NMAP (for dictionary attacks) or Hydra or Medusa
- Nessus (modified as long as they are available in NASL format)
- Nuclei (modifying the way the template is validated by attack actions)
- Burp (Intruder)
- In MS Windows networks: Responder.py, crackmapexec, Impacket tools, Powersploit
- In APIs: Burp
- In some application cases, making use of browser automation with tools like Selenium or performing instrumentation with tools like Frida.
- John the Ripper and/or HashCat

#### Privilege Escalation

- Metasploit
- Burp
- LOLBAS
- GTFOBins
PEASS-ng
